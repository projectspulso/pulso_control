{
  "name": "WF01 - CRON Gerar Roteiros",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "A cada 5 minutos",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  i.id as ideia_id,\n  i.canal_id,\n  i.serie_id,\n  i.titulo,\n  i.descricao,\n  i.tags,\n  i.linguagem,\n  i.metadata,\n  c.nome as canal_nome,\n  c.slug as canal_slug,\n  c.metadata as canal_metadata,\n  s.nome as serie_nome\nFROM pulso_content.ideias i\nJOIN pulso_core.canais c ON c.id = i.canal_id\nLEFT JOIN pulso_content.series s ON s.id = i.serie_id\nWHERE i.status = 'APROVADA'\n  AND NOT EXISTS (\n    SELECT 1 \n    FROM pulso_content.roteiros r \n    WHERE r.ideia_id = i.id\n  )\nORDER BY COALESCE(i.updated_at, i.created_at) ASC\nLIMIT 10;",
        "options": {}
      },
      "id": "buscar-ideias",
      "name": "Buscar Ideias Sem Roteiro",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "q19Ps5vylbEtdVtd",
          "name": "Postgres supabase"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prep001",
              "name": "ideia_id",
              "value": "={{ $json.ideia_id }}",
              "type": "string"
            },
            {
              "id": "prep002",
              "name": "canal_id",
              "value": "={{ $json.canal_id }}",
              "type": "string"
            },
            {
              "id": "prep003",
              "name": "serie_id",
              "value": "={{ $json.serie_id || null }}",
              "type": "string"
            },
            {
              "id": "prep004",
              "name": "titulo",
              "value": "={{ $json.titulo }}",
              "type": "string"
            },
            {
              "id": "prep005",
              "name": "descricao",
              "value": "={{ $json.descricao }}",
              "type": "string"
            },
            {
              "id": "prep006",
              "name": "linguagem",
              "value": "={{ $json.linguagem || 'pt-BR' }}",
              "type": "string"
            },
            {
              "id": "prep007",
              "name": "canal_nome",
              "value": "={{ $json.canal_nome }}",
              "type": "string"
            },
            {
              "id": "prep008",
              "name": "canal_slug",
              "value": "={{ $json.canal_slug }}",
              "type": "string"
            },
            {
              "id": "prep009",
              "name": "tom_voz",
              "value": "={{ $json.canal_metadata?.tom_voz || 'narrativo e envolvente' }}",
              "type": "string"
            },
            {
              "id": "prep010",
              "name": "gancho_sugerido",
              "value": "={{ $json.metadata?.gancho_sugerido || 'Crie um gancho impactante' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "preparar-contexto",
      "name": "Preparar Contexto",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [680, 300]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "=Voc√™ √© um roteirista profissional especializado em v√≠deos curtos virais para redes sociais.\n\n**BRIEFING DO CONTE√öDO:**\nüé¨ Canal: {{ $json.canal_nome }} (@{{ $json.canal_slug }})\nüìå T√≠tulo da Ideia: {{ $json.titulo }}\nüìù Descri√ß√£o: {{ $json.descricao }}\nüí° Gancho Sugerido: {{ $json.gancho_sugerido }}\nüé≠ Tom de Voz: {{ $json.tom_voz }}\n‚è±Ô∏è Dura√ß√£o Alvo: 50 segundos\nüåç Idioma: {{ $json.linguagem }}\n\n---\n\n**TAREFA:**\nCrie um roteiro viral de 50 segundos com ESTA ESTRUTURA:\n\n# [T√çTULO P√öBLICO SUPER CHAMATIVO]\n\n## üé£ GANCHO (0-5 segundos)\n[Primeira frase que PARA o scroll. Deve criar curiosidade ou choque imediato]\n\n## üìñ DESENVOLVIMENTO (5-40 segundos)\n[Narrativa principal com storytelling envolvente. Use estrutura de 3 atos:\n- Contexto inicial (5-15s)\n- Build-up de tens√£o (15-30s)\n- Transi√ß√£o para cl√≠max (30-40s)]\n\n## üéÜ CL√çMAX (40-50 segundos)\n[Revela√ß√£o surpreendente, momento \"uau\" ou conclus√£o impactante]\n\n## üì¢ CTA (50-55 segundos)\n[\"Segue o {{ $json.canal_nome }} para mais!\" ou similar]\n\n---\n\n**METADADOS:**\n- **Hashtags:** #tag1 #tag2 #tag3 #tag4 #tag5\n- **Dura√ß√£o estimada:** Xs\n- **Tom predominante:** [emocional/educativo/misterioso/etc]\n\n---\n\n**DIRETRIZES:**\n‚úÖ Linguagem clara (8¬™ s√©rie)\n‚úÖ Frases curtas (m√°x. 15 palavras)\n‚úÖ Total: 110-130 palavras (~50 segundos)\n‚úÖ Factualmente preciso\n\nResponda APENAS com o roteiro em markdown, seguindo a estrutura acima."
            }
          ]
        },
        "options": {
          "maxTokens": 1500,
          "temperature": 0.75,
          "topP": 1
        }
      },
      "id": "gpt-gerar",
      "name": "GPT-4o - Gerar Roteiro",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.5,
      "position": [900, 300],
      "credentials": {
        "openAiApi": {
          "id": "UiqqtKTHr3xQlkcs",
          "name": "OpenAi pulso_control"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extrair resposta do GPT-4o\nconst response = $input.item.json.message?.content || '';\n\nif (!response || response.trim().length < 100) {\n  throw new Error('Resposta da OpenAI est√° vazia ou muito curta');\n}\n\n// Contexto da ideia\nconst contexto = $('Preparar Contexto').item.json;\n\n// Extrair t√≠tulo (primeira linha com #)\nconst tituloMatch = response.match(/^#\\s+(.+)$/m);\nconst tituloPub = tituloMatch ? tituloMatch[1].replace(/[üé¨üìåüí°üî•‚ú®]/g, '').trim() : contexto.titulo;\n\n// Extrair metadados\nconst hashtagsMatch = response.match(/\\*\\*Hashtags:\\*\\*\\s*([^\\n]+)/);\nconst tomMatch = response.match(/\\*\\*Tom predominante:\\*\\*\\s*([^\\n]+)/);\n\n// Processar hashtags\nconst hashtagsRaw = hashtagsMatch ? hashtagsMatch[1] : '';\nconst hashtags = hashtagsRaw\n  .split(/[\\s,]+/)\n  .filter(h => h.startsWith('#'))\n  .map(h => h.replace('#', '').toLowerCase())\n  .slice(0, 10);\n\n// Calcular m√©tricas\nconst palavrasTotal = response.split(/\\s+/).length;\nconst duracaoSegundos = Math.round(palavrasTotal / 2.5); // ~150 palavras/minuto\n\n// Fun√ß√£o para extrair se√ß√£o\nfunction extractSection(text, sectionName) {\n  const regex = new RegExp(`##\\\\s*[üé£üìñüéÜüì¢]*\\\\s*${sectionName}[\\\\s\\\\S]*?(?=##|$)`, 'i');\n  const match = text.match(regex);\n  return match ? match[0].replace(/##[^\\n]+\\n/, '').trim() : '';\n}\n\nconst gancho = extractSection(response, 'GANCHO');\nconst desenvolvimento = extractSection(response, 'DESENVOLVIMENTO');\nconst climax = extractSection(response, 'CL√çMAX|CLIMAX');\nconst cta = extractSection(response, 'CTA|Call to Action');\n\n// Quality score\nconst temGancho = gancho.length > 50;\nconst temDesenvolvimento = desenvolvimento.length > 200;\nconst temClimax = climax.length > 50;\nconst temCTA = cta.length > 20;\nconst qualityScore = [temGancho, temDesenvolvimento, temClimax, temCTA].filter(Boolean).length * 25;\n\nreturn {\n  json: {\n    // IDs\n    ideia_id: contexto.ideia_id,\n    canal_id: contexto.canal_id,\n    serie_id: contexto.serie_id,\n    \n    // Conte√∫do\n    titulo: tituloPub,\n    conteudo_md: response,\n    \n    // M√©tricas\n    duracao_segundos: duracaoSegundos,\n    palavras_total: palavrasTotal,\n    linguagem: contexto.linguagem,\n    \n    // Metadados\n    hashtags: hashtags,\n    tom_narrativo: tomMatch ? tomMatch[1].trim() : 'narrativo',\n    quality_score: qualityScore,\n    \n    // Se√ß√µes\n    secoes: {\n      gancho: gancho,\n      desenvolvimento: desenvolvimento,\n      climax: climax,\n      cta: cta\n    },\n    \n    // Valida√ß√µes\n    validacoes: {\n      tem_gancho: temGancho,\n      tem_desenvolvimento: temDesenvolvimento,\n      tem_climax: temClimax,\n      tem_cta: temCTA\n    }\n  }\n};"
      },
      "id": "processar-roteiro",
      "name": "Processar Roteiro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO pulso_content.roteiros (\n  ideia_id,\n  canal_id,\n  serie_id,\n  titulo,\n  conteudo_md,\n  duracao_estimado_segundos,\n  status,\n  linguagem,\n  categoria_metadata,\n  metadata\n) VALUES (\n  $1::uuid,\n  $2::uuid,\n  $3::uuid,\n  $4,\n  $5,\n  $6,\n  'RASCUNHO',\n  $7,\n  'PADRAO_COMPLETO',\n  jsonb_build_object(\n    'ai_modelo', 'gpt-4o',\n    'gerado_via', 'cron',\n    'prompt_version', '3.0',\n    'hashtags_sugeridas', $8::jsonb,\n    'tom_narrativo', $9,\n    'palavras_total', $10,\n    'quality_score', $11,\n    'validacoes', $12::jsonb,\n    'secoes', $13::jsonb,\n    'gerado_em', NOW()::text\n  )\n) RETURNING id, titulo, status, duracao_estimado_segundos, created_at;",
        "options": {
          "queryParams": "={{ {\n  \"1\": $json.ideia_id,\n  \"2\": $json.canal_id,\n  \"3\": $json.serie_id,\n  \"4\": $json.titulo,\n  \"5\": $json.conteudo_md,\n  \"6\": $json.duracao_segundos,\n  \"7\": $json.linguagem,\n  \"8\": JSON.stringify($json.hashtags),\n  \"9\": $json.tom_narrativo,\n  \"10\": $json.palavras_total,\n  \"11\": $json.quality_score,\n  \"12\": JSON.stringify($json.validacoes),\n  \"13\": JSON.stringify($json.secoes)\n} }}"
        }
      },
      "id": "salvar-roteiro",
      "name": "Salvar Roteiro",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1340, 300],
      "credentials": {
        "postgres": {
          "id": "q19Ps5vylbEtdVtd",
          "name": "Postgres supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO pulso_content.logs_workflows (\n  workflow_name,\n  status,\n  detalhes,\n  tempo_execucao_ms,\n  created_at\n) VALUES (\n  'WF01_CRON_Gerar_Roteiros',\n  'sucesso',\n  jsonb_build_object(\n    'roteiro_id', $1::uuid,\n    'ideia_id', $2::uuid,\n    'titulo', $3,\n    'duracao_segundos', $4,\n    'quality_score', $5,\n    'timestamp', NOW()::text\n  ),\n  $6,\n  NOW()\n);",
        "options": {
          "queryParams": "={{ {\n  \"1\": $json.id,\n  \"2\": $('Processar Roteiro').item.json.ideia_id,\n  \"3\": $json.titulo,\n  \"4\": $json.duracao_estimado_segundos,\n  \"5\": $('Processar Roteiro').item.json.quality_score,\n  \"6\": $execution.executionTime || 0\n} }}"
        }
      },
      "id": "log-sucesso",
      "name": "Log Sucesso",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1560, 300],
      "credentials": {
        "postgres": {
          "id": "q19Ps5vylbEtdVtd",
          "name": "Postgres supabase"
        }
      }
    }
  ],
  "connections": {
    "A cada 5 minutos": {
      "main": [[{"node": "Buscar Ideias Sem Roteiro", "type": "main", "index": 0}]]
    },
    "Buscar Ideias Sem Roteiro": {
      "main": [[{"node": "Preparar Contexto", "type": "main", "index": 0}]]
    },
    "Preparar Contexto": {
      "main": [[{"node": "GPT-4o - Gerar Roteiro", "type": "main", "index": 0}]]
    },
    "GPT-4o - Gerar Roteiro": {
      "main": [[{"node": "Processar Roteiro", "type": "main", "index": 0}]]
    },
    "Processar Roteiro": {
      "main": [[{"node": "Salvar Roteiro", "type": "main", "index": 0}]]
    },
    "Salvar Roteiro": {
      "main": [[{"node": "Log Sucesso", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [
    {
      "id": "MFytbRYpluf20w5V",
      "name": "PULSO"
    },
    {
      "id": "1oYaJvQyf1LhoYQ3",
      "name": "Automa√ß√£o"
    }
  ],
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true
  }
}