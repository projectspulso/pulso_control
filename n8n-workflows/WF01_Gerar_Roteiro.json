{
  "name": "WF01 - Gerar Roteiro",
  "nodes": [
    {
      "parameters": {
        "path": "ideia-aprovada",
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000001",
      "name": "Webhook Ideia Aprovada",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "ideia-aprovada"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "validate001",
              "name": "ideia_id",
              "value": "={{ $json.body.ideia_id }}",
              "type": "string"
            },
            {
              "id": "validate002",
              "name": "execution_id",
              "value": "={{ $workflow.id + '_' + $execution.id }}",
              "type": "string"
            },
            {
              "id": "validate003",
              "name": "timestamp",
              "value": "={{ new Date().toISOString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000002",
      "name": "Validar Payload",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check001",
              "leftValue": "={{ $json.ideia_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check002",
              "leftValue": "={{ $json.ideia_id }}",
              "rightValue": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000003",
      "name": "Validar UUID",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  i.id as ideia_id,\n  i.canal_id,\n  i.serie_id,\n  i.titulo,\n  i.descricao,\n  i.tags,\n  i.linguagem,\n  i.metadata,\n  i.status as ideia_status,\n  c.nome as canal_nome,\n  c.slug as canal_slug,\n  c.metadata as canal_metadata,\n  s.nome as serie_nome,\n  p.id as pipeline_id,\n  p.status as pipeline_status,\n  -- Verificar se j√° existe roteiro\n  (SELECT COUNT(*) FROM pulso_content.roteiros WHERE ideia_id = i.id) as roteiros_existentes\nFROM pulso_content.ideias i\nJOIN pulso_core.canais c ON c.id = i.canal_id\nLEFT JOIN pulso_content.series s ON s.id = i.serie_id\nLEFT JOIN pulso_content.pipeline_producao p ON p.ideia_id = i.id\nWHERE i.id = $1::uuid\n  AND i.status = 'APROVADA';",
        "options": {
          "queryParams": "={{ { \"1\": $json.ideia_id } }}"
        }
      },
      "id": "00000000-0000-0000-0001-000000000004",
      "name": "Buscar Ideia Completa",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [900, 200],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres supabase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check001",
              "leftValue": "={{ $json.ideia_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000005",
      "name": "Ideia Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "context001",
              "name": "ideia_id",
              "value": "={{ $json.ideia_id }}",
              "type": "string"
            },
            {
              "id": "context002",
              "name": "canal_id",
              "value": "={{ $json.canal_id }}",
              "type": "string"
            },
            {
              "id": "context003",
              "name": "serie_id",
              "value": "={{ $json.serie_id || null }}",
              "type": "string"
            },
            {
              "id": "context004",
              "name": "canal_nome",
              "value": "={{ $json.canal_nome }}",
              "type": "string"
            },
            {
              "id": "context005",
              "name": "canal_slug",
              "value": "={{ $json.canal_slug }}",
              "type": "string"
            },
            {
              "id": "context006",
              "name": "titulo",
              "value": "={{ $json.titulo }}",
              "type": "string"
            },
            {
              "id": "context007",
              "name": "descricao",
              "value": "={{ $json.descricao }}",
              "type": "string"
            },
            {
              "id": "context008",
              "name": "gancho_sugerido",
              "value": "={{ $json.metadata?.gancho_sugerido || 'Crie um gancho impactante que pare o scroll' }}",
              "type": "string"
            },
            {
              "id": "context009",
              "name": "tom_voz",
              "value": "={{ $json.canal_metadata?.tom_voz || 'narrativo e envolvente' }}",
              "type": "string"
            },
            {
              "id": "context010",
              "name": "duracao_alvo",
              "value": "={{ $json.metadata?.duracao_estimada || '50s' }}",
              "type": "string"
            },
            {
              "id": "context011",
              "name": "linguagem",
              "value": "={{ $json.linguagem || 'pt-BR' }}",
              "type": "string"
            },
            {
              "id": "context012",
              "name": "contexto_serie",
              "value": "={{ $json.serie_nome ? 'Epis√≥dio da s√©rie: ' + $json.serie_nome : 'Epis√≥dio avulso' }}",
              "type": "string"
            },
            {
              "id": "context013",
              "name": "tags",
              "value": "={{ $json.tags ? $json.tags.join(', ') : '' }}",
              "type": "string"
            },
            {
              "id": "context014",
              "name": "roteiros_existentes",
              "value": "={{ $json.roteiros_existentes }}",
              "type": "number"
            },
            {
              "id": "context015",
              "name": "execution_id",
              "value": "={{ $('Validar Payload').item.json.execution_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000006",
      "name": "Preparar Contexto Roteiro",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1340, 100]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "content": "=Voc√™ √© um roteirista profissional especializado em v√≠deos curtos virais para redes sociais.\n\n**BRIEFING DO CONTE√öDO:**\nüé¨ Canal: {{ $json.canal_nome }} (@{{ $json.canal_slug }})\nüìå T√≠tulo da Ideia: {{ $json.titulo }}\nüìù Descri√ß√£o: {{ $json.descricao }}\nüí° Gancho Sugerido: {{ $json.gancho_sugerido }}\nüé≠ Tom de Voz: {{ $json.tom_voz }}\n‚è±Ô∏è Dura√ß√£o Alvo: {{ $json.duracao_alvo }}\nüåç Idioma: {{ $json.linguagem }}\nüìö Contexto: {{ $json.contexto_serie }}\nüè∑Ô∏è Tags: {{ $json.tags || 'N/A' }}\n\n---\n\n**TAREFA:**\nCrie um roteiro COMPLETO e PRONTO PARA GRAVAR seguindo EXATAMENTE esta estrutura:\n\n# [T√çTULO P√öBLICO SUPER CHAMATIVO]\n\n## üé£ GANCHO (0-5 segundos)\n[Primeira frase que PARA o scroll. Use t√©cnicas:\n- Pergunta intrigante\n- Fato chocante\n- Promessa de revela√ß√£o\n- Contraste inesperado]\n\n**Exemplo:** \"Voc√™ sabia que 90% das pessoas fazem isso errado?\"\n\n---\n\n## üìñ DESENVOLVIMENTO (5-40 segundos)\n[Narrativa principal com storytelling progressivo. Use estrutura de 3 atos]\n\n### ATO 1 - Contexto (5-15s):\n[Estabele√ßa o cen√°rio. Apresente o problema/situa√ß√£o]\n\n### ATO 2 - Complica√ß√£o (15-30s):\n[Build-up de tens√£o. Adicione camadas de complexidade]\n\n**FATOS CHAVE:**\n- üìä Dado/Estat√≠stica relevante\n- üî¨ Evid√™ncia cient√≠fica ou hist√≥rica\n- üí° Insight surpreendente\n- üéØ Implica√ß√£o pr√°tica\n\n### ATO 3 - Resolu√ß√£o (30-40s):\n[Transi√ß√£o para o cl√≠max. Prepare o terreno para a revela√ß√£o]\n\n---\n\n## üéÜ CL√çMAX (40-50 segundos)\n[MOMENTO \"UAU\"! Use uma dessas t√©cnicas:\n- Plot twist surpreendente\n- Revela√ß√£o contra-intuitiva\n- Conex√£o inesperada\n- Conclus√£o impactante]\n\n**Este deve ser o momento mais memor√°vel do v√≠deo!**\n\n---\n\n## üì¢ CTA - Call to Action (50-55 segundos)\n[Engajamento natural. Escolha UMA op√ß√£o:\n- \"Segue o {{ $json.canal_nome }} para mais conte√∫dos assim!\"\n- \"Comenta aqui o que voc√™ achou disso!\"\n- \"Compartilha com quem precisa ver isso!\"\n- \"Salva esse v√≠deo para assistir de novo!\"]\n\n---\n\n**METADADOS DO ROTEIRO:**\n- **Hashtags:** #tag1 #tag2 #tag3 #tag4 #tag5 (espec√≠ficas e relevantes)\n- **Dura√ß√£o estimada:** Xs (calculada)\n- **Tom predominante:** [emocional/educativo/misterioso/inspirador/etc]\n- **Plataforma ideal:** [TikTok/YouTube Shorts/Instagram Reels]\n- **Momento ideal:** [manh√£/tarde/noite/qualquer]\n- **P√∫blico-alvo:** [demogr√°fico espec√≠fico]\n\n---\n\n**DIRETRIZES OBRIGAT√ìRIAS:**\n\n‚úÖ **FAZER:**\n1. Linguagem clara e acess√≠vel (8¬™ s√©rie)\n2. Frases curtas (m√°x. 15 palavras)\n3. Usar transi√ß√µes suaves entre ideias\n4. Criar tens√£o narrativa progressiva\n5. Total: 110-130 palavras (~50 segundos)\n6. Factualmente preciso e verific√°vel\n7. Usar n√∫meros e dados espec√≠ficos\n8. Incluir elementos visuais sugeridos [entre colchetes]\n9. Marcar pausas dram√°ticas com \"...\"\n10. Variar ritmo narrativo para manter aten√ß√£o\n\n‚ùå **EVITAR:**\n1. Jarg√µes t√©cnicos desnecess√°rios\n2. Explica√ß√µes longas e confusas\n3. M√∫ltiplos conceitos por frase\n4. Linguagem muito formal ou acad√™mica\n5. Cita√ß√µes sem contexto\n6. Compara√ß√µes muito complexas\n7. Assumir conhecimento pr√©vio\n\n---\n\n**FORMATO DE SA√çDA:**\nResponda APENAS com o roteiro em markdown limpo, seguindo EXATAMENTE a estrutura acima.\nN√ÉO adicione coment√°rios ou explica√ß√µes fora da estrutura.\nO roteiro deve estar PRONTO para ser enviado ao narrador."
            }
          ]
        },
        "options": {
          "temperature": 0.75,
          "maxTokens": 2000,
          "topP": 1
        }
      },
      "id": "00000000-0000-0000-0001-000000000007",
      "name": "GPT-4o - Gerar Roteiro",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.5,
      "position": [1560, 100],
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_CREDENTIAL_ID",
          "name": "OpenAi pulso_control"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extrair resposta da OpenAI\nconst response = $input.item.json.message?.content || $input.item.json.response || '';\n\nif (!response || response.trim().length < 100) {\n  throw new Error('Resposta da OpenAI est√° vazia ou muito curta');\n}\n\n// Fun√ß√£o para extrair se√ß√£o do markdown\nfunction extractSection(text, sectionName) {\n  const regex = new RegExp(`##\\\\s*[üé£üìñüéÜüì¢]*\\\\s*${sectionName}[\\\\s\\\\S]*?(?=##|$)`, 'i');\n  const match = text.match(regex);\n  return match ? match[0].replace(/##[^\\n]+\\n/, '').trim() : '';\n}\n\n// Extrair se√ß√µes principais\nconst gancho = extractSection(response, 'GANCHO');\nconst desenvolvimento = extractSection(response, 'DESENVOLVIMENTO');\nconst climax = extractSection(response, 'CL√çMAX|CLIMAX');\nconst cta = extractSection(response, 'CTA|Call to Action');\n\n// Extrair metadados\nconst hashtagsMatch = response.match(/\\*\\*Hashtags:\\*\\*\\s*([^\\n]+)/);\nconst duracaoMatch = response.match(/\\*\\*Dura√ß√£o estimada:\\*\\*\\s*([^\\n]+)/);\nconst tomMatch = response.match(/\\*\\*Tom predominante:\\*\\*\\s*([^\\n]+)/);\nconst plataformaMatch = response.match(/\\*\\*Plataforma ideal:\\*\\*\\s*([^\\n]+)/);\nconst momentoMatch = response.match(/\\*\\*Momento ideal:\\*\\*\\s*([^\\n]+)/);\nconst publicoMatch = response.match(/\\*\\*P√∫blico-alvo:\\*\\*\\s*([^\\n]+)/);\n\n// Extrair t√≠tulo (primeira linha com #)\nconst tituloMatch = response.match(/^#\\s+(.+)$/m);\nconst tituloPub = tituloMatch ? tituloMatch[1].replace(/[üé¨üìåüí°üî•‚ú®]/g, '').trim() : $('Preparar Contexto Roteiro').item.json.titulo;\n\n// Processar hashtags\nconst hashtagsRaw = hashtagsMatch ? hashtagsMatch[1] : '';\nconst hashtags = hashtagsRaw\n  .split(/[\\s,]+/)\n  .filter(h => h.startsWith('#'))\n  .map(h => h.replace('#', '').toLowerCase())\n  .slice(0, 10); // M√°ximo 10 hashtags\n\n// Calcular m√©tricas do roteiro\nconst palavrasTotal = response.split(/\\s+/).length;\nconst palavrasNarracao = (gancho + ' ' + desenvolvimento + ' ' + climax + ' ' + cta).split(/\\s+/).length;\nconst duracaoSegundos = Math.round(palavrasNarracao / 2.5); // ~150 palavras/minuto\n\n// Extrair elementos visuais sugeridos\nconst elementosVisuais = [...response.matchAll(/\\[([^\\]]+)\\]/g)].map(m => m[1]);\n\n// Calcular scores de qualidade\nconst temGancho = gancho.length > 50;\nconst temDesenvolvimento = desenvolvimento.length > 200;\nconst temClimax = climax.length > 50;\nconst temCTA = cta.length > 20;\nconst qualityScore = [temGancho, temDesenvolvimento, temClimax, temCTA].filter(Boolean).length * 25;\n\n// Contexto herdado\nconst contexto = $('Preparar Contexto Roteiro').item.json;\n\nreturn {\n  json: {\n    // Roteiro completo\n    roteiro_markdown: response,\n    titulo_publico: tituloPub,\n    \n    // Se√ß√µes estruturadas\n    secoes: {\n      gancho: gancho,\n      desenvolvimento: desenvolvimento,\n      climax: climax,\n      cta: cta\n    },\n    \n    // Metadados extra√≠dos\n    hashtags: hashtags,\n    tom_narrativo: tomMatch ? tomMatch[1].trim() : 'narrativo',\n    plataforma_foco: plataformaMatch ? plataformaMatch[1].trim().toLowerCase() : 'tiktok',\n    momento_ideal: momentoMatch ? momentoMatch[1].trim() : 'qualquer',\n    publico_alvo: publicoMatch ? publicoMatch[1].trim() : 'geral',\n    \n    // M√©tricas\n    duracao_segundos: duracaoSegundos,\n    palavras_total: palavrasTotal,\n    palavras_narracao: palavrasNarracao,\n    elementos_visuais: elementosVisuais,\n    quality_score: qualityScore,\n    \n    // Valida√ß√µes\n    validacoes: {\n      tem_gancho: temGancho,\n      tem_desenvolvimento: temDesenvolvimento,\n      tem_climax: temClimax,\n      tem_cta: temCTA,\n      duracao_ok: duracaoSegundos >= 40 && duracaoSegundos <= 65,\n      palavras_ok: palavrasNarracao >= 110 && palavrasNarracao <= 150\n    },\n    \n    // Contexto da ideia\n    ideia_id: contexto.ideia_id,\n    canal_id: contexto.canal_id,\n    serie_id: contexto.serie_id,\n    linguagem: contexto.linguagem,\n    execution_id: contexto.execution_id,\n    \n    // Metadados de gera√ß√£o\n    gerado_em: new Date().toISOString(),\n    modelo_ai: 'gpt-4o',\n    temperatura: 0.75,\n    max_tokens: 2000\n  }\n};"
      },
      "id": "00000000-0000-0000-0001-000000000008",
      "name": "Processar Roteiro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 100]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO pulso_content.roteiros (\n  ideia_id,\n  canal_id,\n  serie_id,\n  titulo,\n  conteudo_md,\n  duracao_estimado_segundos,\n  status,\n  linguagem,\n  categoria_metadata,\n  metadata\n) VALUES (\n  $1::uuid,\n  $2::uuid,\n  $3::uuid,\n  $4,\n  $5,\n  $6,\n  'RASCUNHO',\n  $7,\n  'PADRAO_COMPLETO',\n  jsonb_build_object(\n    'ai_modelo', $8,\n    'ai_temperatura', $9,\n    'ai_max_tokens', $10,\n    'prompt_version', '3.0',\n    'execution_id', $11,\n    'hashtags_sugeridas', $12::jsonb,\n    'tom_narrativo', $13,\n    'plataforma_foco', $14,\n    'momento_ideal', $15,\n    'publico_alvo', $16,\n    'palavras_total', $17,\n    'palavras_narracao', $18,\n    'elementos_visuais', $19::jsonb,\n    'quality_score', $20,\n    'validacoes', $21::jsonb,\n    'secoes', $22::jsonb,\n    'custo_estimado_usd', 0.004,\n    'gerado_em', $23\n  )\n) RETURNING \n  id, \n  titulo, \n  status, \n  duracao_estimado_segundos,\n  created_at,\n  metadata;",
        "options": {
          "queryParams": "={{ {\n  \"1\": $json.ideia_id,\n  \"2\": $json.canal_id,\n  \"3\": $json.serie_id,\n  \"4\": $json.titulo_publico,\n  \"5\": $json.roteiro_markdown,\n  \"6\": $json.duracao_segundos,\n  \"7\": $json.linguagem,\n  \"8\": $json.modelo_ai,\n  \"9\": $json.temperatura,\n  \"10\": $json.max_tokens,\n  \"11\": $json.execution_id,\n  \"12\": JSON.stringify($json.hashtags),\n  \"13\": $json.tom_narrativo,\n  \"14\": $json.plataforma_foco,\n  \"15\": $json.momento_ideal,\n  \"16\": $json.publico_alvo,\n  \"17\": $json.palavras_total,\n  \"18\": $json.palavras_narracao,\n  \"19\": JSON.stringify($json.elementos_visuais),\n  \"20\": $json.quality_score,\n  \"21\": JSON.stringify($json.validacoes),\n  \"22\": JSON.stringify($json.secoes),\n  \"23\": $json.gerado_em\n} }}"
        }
      },
      "id": "00000000-0000-0000-0001-000000000009",
      "name": "Salvar Roteiro",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2000, 100],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO pulso_content.logs_workflows (\n  workflow_name,\n  status,\n  detalhes,\n  tempo_execucao_ms,\n  created_at\n) VALUES (\n  'WF01_Gerar_Roteiro',\n  'sucesso',\n  jsonb_build_object(\n    'execution_id', $1,\n    'ideia_id', $2::uuid,\n    'roteiro_id', $3::uuid,\n    'titulo', $4,\n    'duracao_segundos', $5,\n    'palavras_narracao', $6,\n    'quality_score', $7,\n    'modelo_ai', $8,\n    'timestamp', NOW()::text\n  ),\n  $9,\n  NOW()\n);",
        "options": {
          "queryParams": "={{ {\n  \"1\": $('Processar Roteiro').item.json.execution_id,\n  \"2\": $('Processar Roteiro').item.json.ideia_id,\n  \"3\": $json.id,\n  \"4\": $json.titulo,\n  \"5\": $json.duracao_estimado_segundos,\n  \"6\": $('Processar Roteiro').item.json.palavras_narracao,\n  \"7\": $('Processar Roteiro').item.json.quality_score,\n  \"8\": $('Processar Roteiro').item.json.modelo_ai,\n  \"9\": $execution.executionTime || 0\n} }}"
        }
      },
      "id": "00000000-0000-0000-0001-000000000010",
      "name": "Log Sucesso",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2220, 100],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres supabase"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"message\": \"Roteiro gerado com sucesso!\",\n  \"data\": {\n    \"roteiro\": {\n      \"id\": $json.id,\n      \"titulo\": $json.titulo,\n      \"status\": $json.status,\n      \"duracao_segundos\": $json.duracao_estimado_segundos,\n      \"created_at\": $json.created_at\n    },\n    \"metricas\": {\n      \"palavras_narracao\": $('Processar Roteiro').item.json.palavras_narracao,\n      \"quality_score\": $('Processar Roteiro').item.json.quality_score,\n      \"hashtags_count\": $('Processar Roteiro').item.json.hashtags.length\n    },\n    \"validacoes\": $('Processar Roteiro').item.json.validacoes,\n    \"metadados\": {\n      \"plataforma_foco\": $('Processar Roteiro').item.json.plataforma_foco,\n      \"tom_narrativo\": $('Processar Roteiro').item.json.tom_narrativo,\n      \"momento_ideal\": $('Processar Roteiro').item.json.momento_ideal\n    }\n  },\n  \"workflow\": {\n    \"execution_id\": $('Processar Roteiro').item.json.execution_id,\n    \"tempo_execucao_ms\": $execution.executionTime || 0,\n    \"modelo_usado\": $('Processar Roteiro').item.json.modelo_ai\n  }\n} }}",
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000011",
      "name": "Resposta Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2440, 100]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": false,\n  \"error\": {\n    \"code\": \"INVALID_UUID\",\n    \"message\": \"ID da ideia inv√°lido ou n√£o informado\",\n    \"details\": \"O ideia_id deve ser um UUID v√°lido\"\n  },\n  \"received\": {\n    \"ideia_id\": $('Validar Payload').item.json.ideia_id\n  },\n  \"workflow\": {\n    \"execution_id\": $('Validar Payload').item.json.execution_id\n  }\n} }}",
        "responseCode": 400,
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000012",
      "name": "Erro - UUID Inv√°lido",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [900, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": false,\n  \"error\": {\n    \"code\": \"IDEIA_NOT_FOUND\",\n    \"message\": \"Ideia n√£o encontrada ou n√£o est√° aprovada\",\n    \"details\": \"Verifique se o ID est√° correto e se a ideia foi aprovada\"\n  },\n  \"received\": {\n    \"ideia_id\": $('Validar Payload').item.json.ideia_id\n  },\n  \"workflow\": {\n    \"execution_id\": $('Validar Payload').item.json.execution_id\n  }\n} }}",
        "responseCode": 404,
        "options": {}
      },
      "id": "00000000-0000-0000-0001-000000000013",
      "name": "Erro - Ideia N√£o Encontrada",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO pulso_content.logs_workflows (\n  workflow_name,\n  status,\n  erro_mensagem,\n  detalhes,\n  tempo_execucao_ms,\n  created_at\n) VALUES (\n  'WF01_Gerar_Roteiro',\n  'erro',\n  $1,\n  jsonb_build_object(\n    'execution_id', $2,\n    'ideia_id', $3,\n    'erro_tipo', $4,\n    'timestamp', NOW()::text\n  ),\n  $5,\n  NOW()\n);",
        "options": {
          "queryParams": "={{ {\n  \"1\": $json.error?.message || 'Ideia n√£o encontrada',\n  \"2\": $('Validar Payload').item.json.execution_id,\n  \"3\": $('Validar Payload').item.json.ideia_id || 'unknown',\n  \"4\": $json.error?.code || 'IDEIA_NOT_FOUND',\n  \"5\": $execution.executionTime || 0\n} }}"
        }
      },
      "id": "00000000-0000-0000-0001-000000000014",
      "name": "Log Erro",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1340, 500],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres supabase"
        }
      }
    }
  ],
  "connections": {
    "Webhook Ideia Aprovada": {
      "main": [
        [
          {
            "node": "Validar Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Payload": {
      "main": [
        [
          {
            "node": "Validar UUID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar UUID": {
      "main": [
        [
          {
            "node": "Buscar Ideia Completa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erro - UUID Inv√°lido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Ideia Completa": {
      "main": [
        [
          {
            "node": "Ideia Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ideia Existe?": {
      "main": [
        [
          {
            "node": "Preparar Contexto Roteiro",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erro - Ideia N√£o Encontrada",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Contexto Roteiro": {
      "main": [
        [
          {
            "node": "GPT-4o - Gerar Roteiro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4o - Gerar Roteiro": {
      "main": [
        [
          {
            "node": "Processar Roteiro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Roteiro": {
      "main": [
        [
          {
            "node": "Salvar Roteiro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Roteiro": {
      "main": [
        [
          {
            "node": "Log Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Sucesso": {
      "main": [
        [
          {
            "node": "Resposta Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    {
      "id": "1",
      "name": "PULSO"
    },
    {
      "id": "2",
      "name": "Automa√ß√£o"
    },
    {
      "id": "3",
      "name": "Roteiro"
    }
  ],
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "nlcisbfdiokmipyihtuz"
  },
  "id": "WF01",
  "versionId": "2.0.0"
}