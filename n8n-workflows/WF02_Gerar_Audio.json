{
  "name": "WF02 - Gerar Áudio TTS",
  "nodes": [
    {
      "parameters": {
        "path": "roteiro-aprovado",
        "options": {}
      },
      "id": "00000000-0000-0000-0002-000000000001",
      "name": "Webhook Roteiro Aprovado",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "roteiro-aprovado"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "val001",
              "name": "roteiro_id",
              "value": "={{ $json.body.roteiro_id }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "00000000-0000-0000-0002-000000000002",
      "name": "Validar Payload",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  r.id as roteiro_id,\n  r.ideia_id,\n  r.canal_id,\n  r.serie_id,\n  r.titulo,\n  r.conteudo_md,\n  r.duracao_estimado_segundos,\n  r.linguagem,\n  r.metadata,\n  i.titulo as ideia_titulo,\n  c.nome as canal_nome,\n  c.slug as canal_slug,\n  p.id as pipeline_id,\n  p.status as pipeline_status\nFROM roteiros r\nJOIN ideias i ON i.id = r.ideia_id\nJOIN canais c ON c.id = r.canal_id\nLEFT JOIN pulso_content.pipeline_producao p ON p.ideia_id = r.ideia_id\nWHERE r.id = '{{ $json.roteiro_id }}'\n  AND r.status = 'APROVADO';",
        "options": {}
      },
      "id": "00000000-0000-0000-0002-000000000003",
      "name": "Buscar Roteiro Aprovado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [680, 300],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres supabase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check001",
              "leftValue": "={{ $json.roteiro_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "00000000-0000-0000-0002-000000000004",
      "name": "Roteiro Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "const markdown = $input.item.json.conteudo_md;\n\nif (!markdown) {\n  throw new Error('Roteiro sem conteúdo');\n}\n\n// Limpar markdown para TTS\nlet textoLimpo = markdown\n  // Remover títulos markdown\n  .replace(/^#{1,6}\\s+/gm, '')\n  // Remover bold/italic\n  .replace(/\\*\\*(.+?)\\*\\*/g, '$1')\n  .replace(/\\*(.+?)\\*/g, '$1')\n  .replace(/_(.+?)_/g, '$1')\n  // Remover links [texto](url)\n  .replace(/\\[(.+?)\\]\\(.+?\\)/g, '$1')\n  // Remover listas markdown\n  .replace(/^[-*+]\\s+/gm, '')\n  // Remover metadados (tudo após ---)\n  .replace(/---[\\s\\S]*$/m, '')\n  // Remover quebras de linha múltiplas\n  .replace(/\\n{3,}/g, '\\n\\n')\n  // Trim\n  .trim();\n\n// Substituir caracteres especiais para pronúncia correta\ntextoLimpo = textoLimpo\n  .replace(/\\b([0-9]+)\\s*%/g, '$1 por cento')\n  .replace(/\\b([0-9]+)\\s*km/g, '$1 quilômetros')\n  .replace(/\\b([0-9]+)\\s*m\\b/g, '$1 metros')\n  .replace(/Dr\\./g, 'Doutor')\n  .replace(/Sr\\./g, 'Senhor')\n  .replace(/Sra\\./g, 'Senhora');\n\n// Contar caracteres\nconst totalCaracteres = textoLimpo.length;\nconst custoEstimado = (totalCaracteres / 1000000) * 15; // $15 per 1M chars (TTS HD)\n\nreturn {\n  json: {\n    texto_tts: textoLimpo,\n    total_caracteres: totalCaracteres,\n    custo_estimado: custoEstimado.toFixed(4),\n    roteiro_id: $input.item.json.roteiro_id,\n    ideia_id: $input.item.json.ideia_id,\n    canal_id: $input.item.json.canal_id,\n    linguagem: $input.item.json.linguagem,\n    titulo: $input.item.json.titulo,\n    duracao_estimada: $input.item.json.duracao_estimado_segundos\n  }\n};"
      },
      "id": "00000000-0000-0000-0002-000000000005",
      "name": "Limpar Markdown para TTS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "jsCode": "// Mapear idioma para voz OpenAI\nconst linguagem = $input.item.json.linguagem || 'pt-BR';\n\nconst vozMapa = {\n  'pt-BR': 'alloy',   // Voz neutra, boa para português\n  'pt-PT': 'alloy',   // Português europeu\n  'en-US': 'nova',    // Inglês americano\n  'en-GB': 'shimmer', // Inglês britânico  \n  'es-ES': 'fable',   // Espanhol\n  'es-MX': 'onyx'     // Espanhol mexicano\n};\n\nconst voz = vozMapa[linguagem] || 'alloy';\n\nreturn {\n  json: {\n    ...input.item.json,\n    voz_selecionada: voz,\n    modelo_tts: 'tts-1-hd',\n    velocidade: 1.0\n  }\n};"
      },
      "id": "00000000-0000-0000-0002-000000000006",
      "name": "Selecionar Voz",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "create",
        "model": "={{ $json.modelo_tts }}",
        "input": "={{ $json.texto_tts }}",
        "voice": "={{ $json.voz_selecionada }}",
        "options": {
          "speed": "={{ $json.velocidade }}"
        }
      },
      "id": "00000000-0000-0000-0002-000000000007",
      "name": "OpenAI TTS",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.5,
      "position": [1560, 200],
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_CREDENTIAL_ID",
          "name": "OpenAi pulso_control"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prep001",
              "name": "audio_binary",
              "value": "={{ $binary.data }}",
              "type": "object"
            },
            {
              "id": "prep002",
              "name": "arquivo_nome",
              "value": "={{ $('Limpar Markdown para TTS').item.json.roteiro_id }}.mp3",
              "type": "string"
            },
            {
              "id": "prep003",
              "name": "storage_path",
              "value": "=audios/{{ $('Limpar Markdown para TTS').item.json.roteiro_id }}.mp3",
              "type": "string"
            }
          ]
        }
      },
      "id": "00000000-0000-0000-0002-000000000008",
      "name": "Preparar Upload",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "audios",
        "fileName": "={{ $json.arquivo_nome }}",
        "binaryData": true,
        "options": {
          "contentType": "audio/mpeg",
          "cacheControl": "public, max-age=31536000"
        }
      },
      "id": "00000000-0000-0000-0002-000000000009",
      "name": "Upload Supabase Storage",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1.0,
      "position": [2000, 200],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase Storage – Pulso"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const roteiroId = $('Limpar Markdown para TTS').item.json.roteiro_id;\nconst projectId = 'nlcisbfdiokmipyihtuz';\n\n// URL pública do Supabase Storage\nconst publicUrl = `https://${projectId}.supabase.co/storage/v1/object/public/audios/${roteiroId}.mp3`;\n\nreturn {\n  json: {\n    public_url: publicUrl,\n    storage_path: $input.item.json.storage_path,\n    roteiro_id: roteiroId,\n    ideia_id: $('Limpar Markdown para TTS').item.json.ideia_id,\n    canal_id: $('Limpar Markdown para TTS').item.json.canal_id,\n    duracao_segundos: $('Limpar Markdown para TTS').item.json.duracao_estimada,\n    total_caracteres: $('Limpar Markdown para TTS').item.json.total_caracteres,\n    custo_geracao: $('Limpar Markdown para TTS').item.json.custo_estimado,\n    voz_utilizada: $('Selecionar Voz').item.json.voz_selecionada,\n    modelo_tts: $('Selecionar Voz').item.json.modelo_tts,\n    linguagem: $('Limpar Markdown para TTS').item.json.linguagem\n  }\n};"
      },
      "id": "00000000-0000-0000-0002-000000000010",
      "name": "Preparar Metadata Áudio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO pulso_content.audios (\n  ideia_id,\n  roteiro_id,\n  canal_id,\n  storage_path,\n  public_url,\n  duracao_segundos,\n  linguagem,\n  formato,\n  tipo,\n  status,\n  metadata\n) VALUES (\n  '{{ $json.ideia_id }}',\n  '{{ $json.roteiro_id }}',\n  '{{ $json.canal_id }}',\n  '{{ $json.storage_path }}',\n  '{{ $json.public_url }}',\n  {{ $json.duracao_segundos }},\n  '{{ $json.linguagem }}',\n  'audio/mpeg',\n  'AUDIO_TTS',\n  'OK',\n  jsonb_build_object(\n    'provedor', 'openai',\n    'modelo', '{{ $json.modelo_tts }}',\n    'voice', '{{ $json.voz_utilizada }}',\n    'caracteres', {{ $json.total_caracteres }},\n    'custo', {{ $json.custo_geracao }},\n    'gerado_em', NOW()::text\n  )\n) RETURNING id, public_url, duracao_segundos, status;",
        "options": {}
      },
      "id": "00000000-0000-0000-0002-000000000011",
      "name": "Salvar Áudio no DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2440, 200],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres supabase"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"audio_id\": $json.id, \"public_url\": $json.public_url, \"duracao\": $json.duracao_segundos + 's', \"status\": $json.status } }}",
        "options": {}
      },
      "id": "00000000-0000-0000-0002-000000000012",
      "name": "Resposta Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2660, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": false, \"error\": \"Roteiro não encontrado ou não aprovado\", \"roteiro_id\": $('Validar Payload').item.json.roteiro_id } }}",
        "responseCode": 404,
        "options": {}
      },
      "id": "00000000-0000-0000-0002-000000000013",
      "name": "Erro - Roteiro Não Encontrado",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO pulso_content.logs_workflows (\n  workflow_name,\n  execution_id,\n  status,\n  roteiro_id,\n  detalhes,\n  created_at\n) VALUES (\n  'WF02_Gerar_Audio',\n  '{{ $workflow.id }}_{{ $execution.id }}',\n  'sucesso',\n  '{{ $('Limpar Markdown para TTS').item.json.roteiro_id }}',\n  jsonb_build_object(\n    'audio_id', '{{ $json.id }}',\n    'duracao_segundos', {{ $json.duracao_segundos }},\n    'public_url', '{{ $json.public_url }}',\n    'timestamp', NOW()::text\n  ),\n  NOW()\n);",
        "options": {}
      },
      "id": "00000000-0000-0000-0002-000000000014",
      "name": "Log Sucesso",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2880, 200],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres supabase"
        }
      }
    }
  ],
  "connections": {
    "Webhook Roteiro Aprovado": {
      "main": [
        [
          {
            "node": "Validar Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Payload": {
      "main": [
        [
          {
            "node": "Buscar Roteiro Aprovado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Roteiro Aprovado": {
      "main": [
        [
          {
            "node": "Roteiro Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Roteiro Existe?": {
      "main": [
        [
          {
            "node": "Limpar Markdown para TTS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erro - Roteiro Não Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar Markdown para TTS": {
      "main": [
        [
          {
            "node": "Selecionar Voz",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Selecionar Voz": {
      "main": [
        [
          {
            "node": "OpenAI TTS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI TTS": {
      "main": [
        [
          {
            "node": "Preparar Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Upload": {
      "main": [
        [
          {
            "node": "Upload Supabase Storage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Supabase Storage": {
      "main": [
        [
          {
            "node": "Preparar Metadata Áudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Metadata Áudio": {
      "main": [
        [
          {
            "node": "Salvar Áudio no DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Áudio no DB": {
      "main": [
        [
          {
            "node": "Resposta Sucesso",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    {
      "id": "1",
      "name": "PULSO"
    },
    {
      "id": "2",
      "name": "Automação"
    }
  ],
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "nlcisbfdiokmipyihtuz"
  },
  "id": "WF02",
  "versionId": "1.0.0"
}
